<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>è©•ä¾¡ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆABCè¨˜éŒ²ãƒ»æ„Ÿæƒ…æ¸©åº¦ï¼‰ï½œãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼†åˆ†æå¯¾å¿œç‰ˆ</title>
<style>
  @page { size: A4; margin: 12mm; }
  @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } .no-print { display:none !important; } .page { box-shadow: none; margin:0; } .btn { display:none !important; } }
  :root{ --ink:#111827; --muted:#6B7280; --line:#E5E7EB; --bg:#FFFFFF; --accent:#0EA5E9; --accent-soft:#E0F2FE; --soft:#F9FAFB; --chip:#F3F4F6; --danger:#EF4444; --ok:#059669; }
  *{box-sizing:border-box}
  body{margin:0; color:var(--ink); background:var(--soft); font-family:"Noto Sans JP",-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;}
  .page{width:210mm; min-height:297mm; background:#fff; margin:8mm auto; box-shadow:0 2px 12px rgba(0,0,0,.06); border-radius:10px; padding:10mm}
  h1{font-size:18pt; margin:0 0 6mm 0}
  h2{font-size:12pt; margin:0 0 3mm 0}
  .row{display:flex; gap:6mm; flex-wrap:wrap; align-items:flex-end}
  .col{flex:1}
  .w-30{flex:0 0 30%} .w-40{flex:0 0 40%} .w-50{flex:0 0 50%}
  .card{border:1px solid var(--line); border-radius:10px; padding:6mm; background:#fff}
  label{font-size:10pt; color:var(--muted); display:block; margin-bottom:2mm}
  input[type="text"],input[type="date"],input[type="time"],textarea{ width:100%; border:1px solid var(--line); border-radius:8px; padding:8px; font-size:11pt; background:#fff; }
  textarea{min-height:80px}
  .chips{display:flex; gap:6px; flex-wrap:wrap; margin-top:6px}
  .chip{font-size:10pt; background:var(--chip); border:1px solid var(--line); padding:6px 10px; border-radius:999px; cursor:pointer; user-select:none}
  .chip.active{outline:2px solid var(--accent); background:var(--accent-soft)}
  .muted{color:var(--muted)} .small{font-size:9pt}
  .btn{border:1px solid var(--line); background:#fff; padding:8px 12px; border-radius:8px; cursor:pointer; font-size:10.5pt}
  .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
  .btn.ok{border-color:var(--ok); color:#fff; background:var(--ok)}
  .btn.danger{border-color:var(--danger); color:var(--danger); background:#fff}
  .btnbar{display:flex; gap:8px; flex-wrap:wrap}
  .table{width:100%; border-collapse:collapse; font-size:10pt}
  .table th,.table td{border:1px solid var(--line); padding:6px; vertical-align:top}
  .table thead th{background:#F3F4F6; text-align:left}
  .thermo-wrap{display:grid; grid-template-columns:1fr; gap:8px}
  .thermo-bar{height:12px; border-radius:999px; background:linear-gradient(90deg,#93C5FD,#60A5FA,#34D399,#F59E0B,#EF4444);} 
  .thermo-scale{display:flex; justify-content:space-between; font-size:10pt}
  .inline{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .stamplist{display:flex; gap:8px; flex-wrap:wrap}
  .stamp{border:1px dashed var(--line); border-radius:8px; padding:6px 8px; font-size:10pt; background:#fff}
  .tagbag{display:flex; gap:6px; flex-wrap:wrap}
  .tag{font-size:10pt; color:#047857; background:#ECFDF5; border:1px solid #A7F3D0; border-radius:999px; padding:2px 8px}
  .hr{height:1px; background:var(--line); margin:6mm 0}
  /* list & analysis */
  .list{width:100%; border-collapse:collapse; font-size:10pt}
  .list th,.list td{border:1px solid var(--line); padding:6px; vertical-align:top}
  .kpi{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
  .kpi .card{padding:10px}
  .kpi .num{font-size:16pt; font-weight:700}
  .toast{position:fixed; right:12px; bottom:12px; background:#111827; color:#fff; padding:10px 12px; border-radius:8px; opacity:.95}
</style>
</head>
<body>
<div class="page" id="rootPage">
  <header class="row">
    <div class="col">
      <h1>è©•ä¾¡ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆABCè¨˜éŒ²ãƒ»æ„Ÿæƒ…æ¸©åº¦ï¼‰</h1>
      <div class="small muted">äº‹å®Ÿï¼ˆè¦³å¯Ÿï¼‰ã¨è§£é‡ˆï¼ˆä»®èª¬ï¼‰ã‚’åˆ†ã‘ã¦ã€çŸ­æ–‡ã§è¨˜éŒ²ã€‚</div>
    </div>
    <div class="w-40"><label>æ—¥ä»˜</label><input id="f-date" type="date" /></div>
    <div class="w-30"><label>è¨˜éŒ²è€…</label><input id="f-recorder" type="text" placeholder="ãŠåå‰ / å½¹å‰²" /></div>
    <div class="w-30"><label>å¯¾è±¡è€…</label><input id="f-target" type="text" placeholder="ãŠåå‰ / ID" /></div>
  </header>

  <section class="row" style="margin-top:8mm">
    <div class="col card">
      <h2>æ„Ÿæƒ…æ¸©åº¦è¨ˆï¼ˆ0â€“10ï¼‰</h2>
      <div class="thermo-wrap">
        <div class="thermo-bar" id="thermoBar" title="ã‚¯ãƒªãƒƒã‚¯ã§å€¤ã‚’è¨­å®š"></div>
        <div class="inline">
          <input id="thermo" type="range" min="0" max="10" step="1" value="0" aria-label="æ„Ÿæƒ…æ¸©åº¦" />
          <span>ç¾åœ¨å€¤ï¼š<b id="thermoVal">0</b></span>
          <button class="btn" id="btn-stamp">ä»Šã®å€¤ã‚’è¨˜éŒ²</button>
          <button class="btn" id="btn-clear-stamps">è¨˜éŒ²ã‚¯ãƒªã‚¢</button>
        </div>
        <div class="thermo-scale"><span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span></div>
        <div class="small muted">0â€“2 è½ã¡ç€ã / 3â€“4 æ³¨æ„ / 5â€“6 ä¸å¿«ãƒ»ç·Šå¼µ / 7â€“8 é«˜è² è· / 9â€“10 å±æ©Ÿ</div>
        <div class="stamplist" id="stamplist" aria-live="polite"></div>
      </div>
    </div>

    <div class="col card">
      <h2>åŸºæœ¬æƒ…å ±ãƒ»çŠ¶æ³å…¥åŠ›</h2>
      <label>å ´é¢ / æ´»å‹•</label>
      <input id="f-scene" type="text" placeholder="ä¾‹ï¼‰å¸°ã‚Šã®ä¼šï¼ã‚µãƒƒã‚«ãƒ¼ç·´ç¿’ï¼å¤–å‡ºå…ˆã®åº—å†…" />
      <div class="row" style="margin-top:6px">
        <div class="w-50"><label>å ´æ‰€</label><input id="f-place" type="text" placeholder="æ•™å®¤Aï¼ä½“è‚²é¤¨ï¼è‡ªå®… ç­‰" /></div>
        <div class="w-50"><label>é–¢ã‚ã£ãŸäºº</label><input id="f-people" type="text" placeholder="æ‹…ä»»ï¼ã‚³ãƒ¼ãƒï¼å‹ã ã¡2åï¼å®¶æ— ç­‰" /></div>
      </div>
      <label style="margin-top:6px">é…æ…®ãƒ»åˆç†çš„é…æ…®ï¼ˆäº‹å‰ï¼‰</label>
      <input id="f-accom" type="text" placeholder="å¸­é…ç½®ï¼äº‹å‰äºˆå‘Šï¼é¸æŠè‚¢æç¤º ç­‰" />
      <div class="small muted" style="margin-top:4px">é–¢é€£ã‚¿ã‚°ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ON/OFFï¼‰</div>
      <div id="chipWrap" class="chips"></div>
      <div id="activeTags" class="tagbag" style="margin-top:6px"></div>
    </div>
  </section>

  <section class="card" style="margin-top:8mm">
    <div class="row" style="justify-content:space-between; align-items:center">
      <h2 style="margin:0">ABCè¨˜éŒ²ï¼ˆäº‹å®Ÿãƒ™ãƒ¼ã‚¹ï¼‰</h2>
      <div class="btnbar no-print">
        <button class="btn" id="btn-add-row">è¡Œã‚’è¿½åŠ </button>
        <button class="btn danger" id="btn-clear-rows">å…¨è¡Œã‚¯ãƒªã‚¢</button>
      </div>
    </div>
    <table class="table" id="abcTable" aria-label="ABCè¨˜éŒ²ãƒ†ãƒ¼ãƒ–ãƒ«">
      <thead>
      <tr>
        <th style="width:10%">æ™‚åˆ»</th>
        <th style="width:18%">å ´é¢ãƒ»çŠ¶æ³ï¼ˆAï¼‰</th>
        <th style="width:20%">ç›´å‰ã®ãã£ã‹ã‘ï¼ˆA è©³ç´°ï¼‰</th>
        <th style="width:22%">è¡Œå‹•ï¼ˆBï¼šè¦³å¯Ÿäº‹å®Ÿï¼‰</th>
        <th style="width:10%">å¼·åº¦/æ™‚é–“</th>
        <th style="width:20%">çµæœï¼å‘¨å›²ã®å¯¾å¿œï¼ˆCï¼‰</th>
        <th class="no-print" style="width:6%">å‰Šé™¤</th>
      </tr>
      </thead>
      <tbody id="abcBody"></tbody>
    </table>
  </section>

  <section class="row" style="margin-top:8mm">
    <div class="col card">
      <h2>è¦³å¯Ÿã¾ã¨ã‚ï¼ˆä»Šæ—¥ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰</h2>
      <textarea id="f-highlight" placeholder="ã†ã¾ãã„ã£ãŸã“ã¨ï¼æœ¬äººãŒé ‘å¼µã£ãŸç‚¹"></textarea>
      <label style="margin-top:6px">ãƒˆãƒªã‚¬ãƒ¼å‚¾å‘ï¼ˆæ™‚é–“å¸¯ãƒ»äººãƒ»ç’°å¢ƒéŸ³ãƒ»èª²é¡Œç¨® ãªã©ï¼‰</label>
      <textarea id="f-triggers"></textarea>
    </div>
    <div class="col card">
      <h2>åŠ¹æœã®ã‚ã£ãŸå¯¾å¿œï¼ˆãªãœåŠ¹ã„ãŸï¼Ÿ ä»®èª¬ã‚’ä¸€è¨€ï¼‰</h2>
      <textarea id="f-effective" placeholder="è¨€è‘‰ãŒã‘ï¼ç’°å¢ƒèª¿æ•´ï¼é¸æŠè‚¢ï¼è¦–è¦šæ”¯æ´ ãªã©"></textarea>
    </div>
    <div class="col card">
      <h2>æ¬¡ã«è©¦ã™ã“ã¨ï¼ˆä»®èª¬ï¼‰</h2>
      <textarea id="f-next" placeholder="ä¾‹ï¼‰äºˆå®šå¤‰æ›´ã¯5åˆ†å‰ã«è¦–è¦šã§äºˆå‘Šï¼ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³å ´æ‰€ã‚’å›ºå®šã™ã‚‹ ãªã©"></textarea>
      <div class="row" style="margin-top:6px">
        <div class="w-50"><label>æ¬¡å›ã®è¦³å¯Ÿãƒã‚¤ãƒ³ãƒˆ</label><input id="f-observe" type="text" placeholder="ä¾‹ï¼‰å£°é‡ã®å¤‰åŒ–ï¼åº§ä½æ™‚é–“" /></div>
        <div class="w-50"><label>å…±æœ‰å…ˆ</label><input id="f-share" type="text" placeholder="å®¶åº­ï¼å­¦æ ¡ï¼ãƒ‡ã‚¤ï¼ã‚³ãƒ¼ãƒ ãªã©" /></div>
      </div>
    </div>
  </section>

  <div class="hr"></div>

  <!-- ä¿å­˜/èª­ã¿è¾¼ã¿/å°åˆ·/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
  <section class="row no-print" style="align-items:center">
    <div class="btnbar">
      <button class="btn ok" id="btn-save-local">ä¿å­˜ï¼ˆç«¯æœ«ãƒ­ãƒ¼ã‚«ãƒ«ï¼‰</button>
      <button class="btn" id="btn-load-draft">ä¸‹æ›¸ãå¾©å…ƒ</button>
      <button class="btn" id="btn-export-json">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆJSONï¼‰</button>
      <button class="btn" id="btn-export-csv">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆCSVï¼‰</button>
      <button class="btn primary" id="btn-print">å°åˆ·</button>
      <label class="btn" for="file-import" id="btn-import">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</label>
      <input id="file-import" type="file" accept=".json" style="display:none"/>
    </div>
    <div class="small muted">â€» ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«è¤‡æ•°ä»¶ã‚’è“„ç©ã€‚ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã¯ä¸€æ‹¬æ›¸ãå‡ºã—ã€‚</div>
  </section>

  <section class="card no-print" style="margin-top:8mm">
    <div class="row" style="justify-content:space-between; align-items:center">
      <h2 style="margin:0">ä¿å­˜ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ & ç°¡æ˜“åˆ†æ</h2>
      <div class="btnbar">
        <button class="btn" id="btn-refresh-list">ä¸€è¦§æ›´æ–°</button>
        <button class="btn danger" id="btn-delete-selected">é¸æŠã‚’å‰Šé™¤</button>
      </div>
    </div>
    <table class="list" id="recordsTable" aria-label="ä¿å­˜ãƒ‡ãƒ¼ã‚¿ä¸€è¦§">
      <thead><tr><th></th><th>ID</th><th>æ—¥ä»˜</th><th>å¯¾è±¡è€…</th><th>å ´é¢</th><th>æ¸©åº¦(ç¾åœ¨)</th><th>ABCä»¶æ•°</th><th>ã‚¿ã‚°</th><th>æ“ä½œ</th></tr></thead>
      <tbody id="recordsBody"></tbody>
    </table>
    <div class="kpi">
      <div class="card"><div class="small muted">ä¿å­˜ä»¶æ•°</div><div class="num" id="kpi-count">0</div></div>
      <div class="card"><div class="small muted">å¹³å‡æ¸©åº¦ï¼ˆã‚¹ã‚¿ãƒ³ãƒ—å¹³å‡ï¼‰</div><div class="num" id="kpi-avg">-</div></div>
      <div class="card"><div class="small muted">ã‚¿ã‚°ä¸Šä½</div><div id="kpi-tags" class="small"></div></div>
    </div>
  </section>

  <footer style="margin-top:6mm" class="small muted">Â© AmeCan. / ABCï¼‹æ„Ÿæƒ…æ¸©åº¦ãƒ†ãƒ³ãƒ—ãƒ¬ â€” äº‹å®Ÿè¨˜éŒ² â†’ è§£é‡ˆåˆ†é›¢ â†’ å°ã•ãªä»®èª¬æ¤œè¨¼</footer>
</div>

<!-- ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆãƒ†ã‚­ã‚¹ãƒˆè»¢é€ç”¨ï¼‰ -->
<dialog id="dlDialog"><div class="dlg-head">ä¿å­˜ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆä»£æ›¿æ‰‹æ®µï¼‰</div><div class="dlg-body"><p class="small muted">ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ .json ã‚‚ã—ãã¯ .csv ã¨ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚</p><textarea id="dlText" class="full mono" spellcheck="false"></textarea></div><div class="dlg-foot"><button class="btn" onclick="copyDlText()">ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button><button class="btn primary" onclick="this.closest('dialog').close()">é–‰ã˜ã‚‹</button></div></dialog>
<div id="toast" class="toast" style="display:none"></div>

<script>
(function(){
  const STORAGE_PREFIX = 'amecan_abc_records_v1';
  const DRAFT_KEY = STORAGE_PREFIX + '__draft';

  function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 1600); }

  function nowId(){ const d=new Date(); const z=n=>String(n).padStart(2,'0'); return d.getFullYear()+z(d.getMonth()+1)+z(d.getDate())+'-'+z(d.getHours())+z(d.getMinutes())+z(d.getSeconds()); }

  // ====== UIå‚ç…§ ======
  const refs = {};
  function $id(id){ return document.getElementById(id); }

  function initRefs(){ Object.assign(refs, {
    thermo: $id('thermo'), thermoVal: $id('thermoVal'), thermoBar: $id('thermoBar'), stamplist: $id('stamplist'),
    chipWrap: $id('chipWrap'), activeTags: $id('activeTags'), abcBody: $id('abcBody'), rootPage: $id('rootPage'),
    recordsBody: $id('recordsBody'), kpiCount: $id('kpi-count'), kpiAvg: $id('kpi-avg'), kpiTags: $id('kpi-tags')
  }); }

  // ====== å…¥åŠ›ãƒ»UI ======
  const TAGS = ["âš™ï¸ æ„Ÿè¦š","ğŸ—£ï¸ ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³","ğŸ—“ï¸ äºˆå®šå¤‰æ›´","ğŸ‘¥ å¯¾äººé–¢ä¿‚","ğŸ·ï¸ å®¿é¡Œãƒ»èª²é¡Œ","ğŸšŒ ç§»å‹•","ğŸ¯ ç›®æ¨™é›£æ˜“åº¦","ğŸ”Š é¨’éŸ³","ğŸ•’ æ™‚é–“å¸¯","ğŸ½ï¸ é£Ÿäº‹å‰å¾Œ","ğŸŸï¸ é›†å›£æ´»å‹•","ğŸ§  èªçŸ¥è² è·"];
  const activeTagSet = new Set();
  function fmtTime(d=new Date()){ const z=n=>String(n).padStart(2,'0'); return `${z(d.getHours())}:${z(d.getMinutes())}`; }

  function bindThermo(){
    refs.thermo.addEventListener('input', e=> refs.thermoVal.textContent = e.target.value );
    refs.thermoBar.addEventListener('click', e=>{ const r = refs.thermoBar.getBoundingClientRect(); const val = Math.max(0, Math.min(10, Math.round(((e.clientX - r.left)/r.width)*10))); refs.thermo.value = val; refs.thermo.dispatchEvent(new Event('input')); });
    $id('btn-stamp').addEventListener('click', ()=>{ const v = refs.thermo.value; const span=document.createElement('span'); span.className='stamp'; span.textContent=`${fmtTime()} â†’ ${v}`; refs.stamplist.appendChild(span); });
    $id('btn-clear-stamps').addEventListener('click', ()=> refs.stamplist.innerHTML='' );
  }

  function renderChips(){
    refs.chipWrap.innerHTML='';
    TAGS.forEach(tag=>{ const b=document.createElement('span'); b.className='chip'; b.textContent=tag; b.addEventListener('click', ()=>{ activeTagSet.has(tag)? activeTagSet.delete(tag): activeTagSet.add(tag); b.classList.toggle('active'); renderActiveTags(); }); refs.chipWrap.appendChild(b); });
  }
  function renderActiveTags(){ refs.activeTags.innerHTML=''; [...activeTagSet].forEach(tag=>{ const s=document.createElement('span'); s.className='tag'; s.textContent=tag; refs.activeTags.appendChild(s); }); }

  function makeRow(data={}){ const tr=document.createElement('tr'); tr.innerHTML=`<td><input type="time" value="${data.time||''}"></td><td><input type="text" placeholder="å ´é¢ãƒ»çŠ¶æ³" value="${data.scene||''}"></td><td><input type="text" placeholder="ç›´å‰ã®ãã£ã‹ã‘" value="${data.ante||''}"></td><td><input type="text" placeholder="è¡Œå‹•ï¼ˆäº‹å®Ÿï¼‰" value="${data.behav||''}"></td><td><input type="text" placeholder="ä¾‹ï¼‰ä¸­ï¼3åˆ†" value="${data.intdur||''}"></td><td><input type="text" placeholder="çµæœï¼å‘¨å›²ã®å¯¾å¿œ" value="${data.consq||''}"></td><td class="no-print"><button class="btn danger btn-del">å‰Šé™¤</button></td>`; tr.querySelector('.btn-del')?.addEventListener('click', ()=> tr.remove()); return tr; }
  function addRow(prefill={}){ refs.abcBody.appendChild(makeRow(prefill)); }

  function collect(){ const get=id=>$id(id)?.value||''; const rows=[...refs.abcBody.querySelectorAll('tr')].map(tr=>{ const t=[...tr.querySelectorAll('td input')]; return {time:t[0]?.value||'',scene:t[1]?.value||'',ante:t[2]?.value||'',behav:t[3]?.value||'',intdur:t[4]?.value||'',consq:t[5]?.value||''};}); const stamps=[...refs.stamplist.querySelectorAll('.stamp')].map(s=>s.textContent); return { meta:{date:get('f-date'),recorder:get('f-recorder'),target:get('f-target')}, situation:{scene:get('f-scene'),place:get('f-place'),people:get('f-people'),accommodations:get('f-accom'),tags:[...activeTagSet]}, thermometer:{value:Number(refs.thermo.value||0),stamps}, abc:rows, reflection:{highlight:get('f-highlight'),triggers:get('f-triggers'),effective:get('f-effective'),next:get('f-next'),observe:get('f-observe'),share:get('f-share')} }; }

  function fill(data){ const set=(id,val)=>{ const el=$id(id); if(el) el.value=val||''; }; if(!data) return; set('f-date', data.meta?.date); set('f-recorder', data.meta?.recorder); set('f-target', data.meta?.target); set('f-scene', data.situation?.scene); set('f-place', data.situation?.place); set('f-people', data.situation?.people); set('f-accom', data.situation?.accommodations); activeTagSet.clear(); (data.situation?.tags||[]).forEach(t=>activeTagSet.add(t)); [...document.querySelectorAll('.chip')].forEach(c=> c.classList.toggle('active', activeTagSet.has(c.textContent)) ); renderActiveTags(); refs.thermo.value = data.thermometer?.value ?? 0; refs.thermo.dispatchEvent(new Event('input')); refs.stamplist.innerHTML=''; (data.thermometer?.stamps||[]).forEach(s=>{ const span=document.createElement('span'); span.className='stamp'; span.textContent=s; refs.stamplist.appendChild(span); }); refs.abcBody.innerHTML=''; (data.abc||[]).forEach(r=> addRow(r)); if((data.abc||[]).length===0) addRow(); set('f-highlight', data.reflection?.highlight); set('f-triggers', data.reflection?.triggers); set('f-effective', data.reflection?.effective); set('f-next', data.reflection?.next); set('f-observe', data.reflection?.observe); set('f-share', data.reflection?.share); }

  // ====== ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼ˆè¤‡æ•°ä»¶ç®¡ç†ï¼‰ ======
  function indexKey(){ return STORAGE_PREFIX + '__index'; }
  function readIndex(){ try{ return JSON.parse(localStorage.getItem(indexKey())||'[]'); }catch(_){ return []; } }
  function writeIndex(arr){ localStorage.setItem(indexKey(), JSON.stringify(arr)); }
  function composeKey(id){ return STORAGE_PREFIX+':'+id; }

  function saveLocal(){ const data = collect(); const id = nowId() + (data.meta?.target ? ('_'+ data.meta.target) : ''); const idx = readIndex(); idx.unshift({ id, date: data.meta?.date||'', target: data.meta?.target||'', scene: data.situation?.scene||'', thermo: data.thermometer?.value||0, abcCount: (data.abc||[]).length, tags: data.situation?.tags||[] }); writeIndex(idx); localStorage.setItem(composeKey(id), JSON.stringify(data)); localStorage.setItem(DRAFT_KEY, JSON.stringify(data)); toast('ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã—ã¾ã—ãŸ'); refreshList(); return id; }
  function loadById(id){ const txt = localStorage.getItem(composeKey(id)); if(!txt){ alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; } fill(JSON.parse(txt)); toast('èª­ã¿è¾¼ã¿ã¾ã—ãŸ'); }
  function deleteIds(ids){ const idx = readIndex().filter(row=> !ids.includes(row.id)); writeIndex(idx); ids.forEach(id=> localStorage.removeItem(composeKey(id))); refreshList(); }

  function exportAllJSON(){ const idx = readIndex(); const arr = idx.map(r=> ({ id:r.id, ...JSON.parse(localStorage.getItem(composeKey(r.id))||'{}') })); const txt = JSON.stringify(arr, null, 2); return txt; }
  function csvEscape(v){ if(v==null) v=''; v=String(v).replace(/\r?\n/g,'\n'); return /[",\n]/.test(v)? '"'+v.replace(/"/g,'""')+'"': v; }
  function exportAllCSV(){ const idx = readIndex(); const lines = []; lines.push('id,æ—¥ä»˜,å¯¾è±¡è€…,å ´é¢,æ¸©åº¦,ABCä»¶æ•°,ã‚¿ã‚°'); idx.forEach(r=> lines.push([r.id, r.date, csvEscape(r.target), csvEscape(r.scene), r.thermo, r.abcCount, csvEscape((r.tags||[]).join(' '))].join(',')) ); return '\uFEFF'+lines.join('\n'); }

  function refreshList(){ const idx = readIndex(); const tbody = refs.recordsBody; tbody.innerHTML=''; idx.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td><input type="checkbox" class="sel" data-id="${r.id}"></td><td class="mono">${r.id}</td><td>${r.date||''}</td><td>${csvEscape(r.target||'')}</td><td>${csvEscape(r.scene||'')}</td><td>${r.thermo}</td><td>${r.abcCount}</td><td>${csvEscape((r.tags||[]).join(' '))}</td><td><button class="btn" data-load="${r.id}">èª­ã¿è¾¼ã¿</button></td>`; tbody.appendChild(tr); }); updateKPI(); }

  function updateKPI(){ const idx = readIndex(); refs.kpiCount.textContent = String(idx.length); // å¹³å‡æ¸©åº¦ï¼ˆã‚¹ã‚¿ãƒ³ãƒ—ãŒã‚ã‚Œã°å¹³å‡ã€ãªã‘ã‚Œã°ç¾åœ¨å€¤ï¼‰
    let sum=0, cnt=0; const tagCounter=new Map();
    idx.forEach(row=>{ const objTxt = localStorage.getItem(composeKey(row.id)); if(!objTxt) return; try{ const data = JSON.parse(objTxt); const stamps = data.thermometer?.stamps||[]; if(stamps.length){ stamps.forEach(s=>{ const m = s.match(/\u2192|â†’\s*(\d+)/); // extract number after arrow
        const v = Number((s.split('â†’')[1]||'').trim()); if(!Number.isNaN(v)){ sum+=v; cnt++; } }); } else { sum += Number(data.thermometer?.value||0); cnt++; }
        (data.situation?.tags||[]).forEach(t=> tagCounter.set(t, (tagCounter.get(t)||0)+1)); }catch(_){}
    });
    refs.kpiAvg.textContent = cnt? (Math.round((sum/cnt)*10)/10).toFixed(1): '-';
    const topTags = [...tagCounter.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5).map(([t,c])=>`${t}:${c}`).join(' / ');
    refs.kpiTags.textContent = topTags || '-';
  }

  // ====== ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ–ãƒ­ãƒƒã‚¯æ™‚ã¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºï¼‰ ======
  function ensureLink(){ let a=document.getElementById('fallbackLink'); if(!a){ a=document.createElement('a'); a.id='fallbackLink'; a.style.display='none'; a.download=''; document.body.appendChild(a);} return a; }
  function downloadText(filename, mime, content){ try{ const blob=new Blob([content],{type:mime}); const url=URL.createObjectURL(blob); const a=ensureLink(); a.href=url; a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 15000); return true; }catch(e){ return false; } }
  function openDlg(text){ const dlg=$id('dlDialog'); const ta=$id('dlText'); ta.value=text; try{ dlg.showModal(); }catch(_){ dlg.setAttribute('open','open'); } ta.focus(); ta.select(); }
  window.copyDlText = function(){ const ta=$id('dlText'); ta.select(); try{ document.execCommand('copy'); toast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }catch(_){ } };

  // ====== å°åˆ· ======
  function handlePrint(){ let win=null; try{ win = window.open('', '_blank'); }catch(_){ win=null; } const styles = Array.from(document.querySelectorAll('style, link[rel="stylesheet"]')).map(n=>n.outerHTML).join('\n'); const html = `<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"/>${styles}</head><body>${$id('rootPage').outerHTML}<script>setTimeout(()=>window.print(),100);<\/script></body></html>`; if(win && win.document){ win.document.open(); win.document.write(html); win.document.close(); try{ win.focus(); }catch(_){ } } else { // iframe fallback
      const iframe = document.createElement('iframe'); Object.assign(iframe.style,{position:'fixed',right:'0',bottom:'0',width:'0',height:'0',border:'0'}); document.body.appendChild(iframe); iframe.contentDocument.open(); iframe.contentDocument.write(html); iframe.contentDocument.close(); setTimeout(()=>{ try{ iframe.contentWindow.print(); }catch(_){ window.print(); } finally{ setTimeout(()=>iframe.remove(), 1000); } }, 120);
  } }

  // ====== ã‚¤ãƒ³ãƒãƒ¼ãƒˆ ======
  function importJSONFile(file){ const reader=new FileReader(); reader.onload = ()=>{ try{ const arr = JSON.parse(reader.result||'[]'); if(!Array.isArray(arr)) throw new Error('é…åˆ—ã®JSONãŒå¿…è¦ã§ã™'); // æœŸå¾…: [{id, ...data}]
        const idx = readIndex(); arr.forEach(rec=>{ if(!rec || !rec.id) return; localStorage.setItem(composeKey(rec.id), JSON.stringify(rec)); const brief = { id:rec.id, date:rec.meta?.date||'', target:rec.meta?.target||'', scene:rec.situation?.scene||'', thermo:rec.thermometer?.value||0, abcCount:(rec.abc||[]).length, tags:rec.situation?.tags||[] }; if(!idx.find(x=>x.id===rec.id)) idx.push(brief); }); writeIndex(idx); toast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ'); refreshList(); }catch(e){ alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: '+e.message); } }; reader.readAsText(file,'utf-8'); }

  // ====== åˆæœŸåŒ– ======
  function init(){ initRefs(); bindThermo(); renderChips(); addRow(); addRow(); // åˆæœŸè¡Œ
    // Draft: å…¥åŠ›ã‚’è‡ªå‹•ä¿å­˜ï¼ˆ30ç§’ï¼‰
    setInterval(()=>{ localStorage.setItem(DRAFT_KEY, JSON.stringify(collect())); }, 30000);

    // Buttons
    $id('btn-save-local').addEventListener('click', saveLocal);
    $id('btn-load-draft').addEventListener('click', ()=>{ const txt = localStorage.getItem(DRAFT_KEY); if(!txt){ toast('ä¸‹æ›¸ãã¯ã‚ã‚Šã¾ã›ã‚“'); return; } fill(JSON.parse(txt)); toast('ä¸‹æ›¸ãã‚’å¾©å…ƒã—ã¾ã—ãŸ'); });
    $id('btn-export-json').addEventListener('click', ()=>{ const txt = exportAllJSON(); const ok = downloadText('abc_records_export.json','application/json',txt); if(!ok){ openDlg(txt); } });
    $id('btn-export-csv').addEventListener('click', ()=>{ const txt = exportAllCSV(); const ok = downloadText('abc_records_summary.csv','text/csv;charset=utf-8;',txt); if(!ok){ openDlg(txt); } });
    $id('btn-print').addEventListener('click', handlePrint);
    $id('btn-refresh-list').addEventListener('click', refreshList);
    $id('btn-delete-selected').addEventListener('click', ()=>{ const ids=[...document.querySelectorAll('#recordsBody .sel:checked')].map(c=>c.getAttribute('data-id')); if(!ids.length){ toast('å¯¾è±¡ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“'); return; } if(!confirm(ids.length+'ä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; deleteIds(ids); });
    $id('recordsBody').addEventListener('click', e=>{ const id=e.target?.getAttribute?.('data-load'); if(id) loadById(id); });
    $id('file-import').addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) importJSONFile(f); e.target.value=''; });

    refreshList();

    // èµ·å‹•æ™‚ã«ä¸‹æ›¸ããŒã‚ã‚Œã°è»½ãæ¡ˆå†…
    if(localStorage.getItem(DRAFT_KEY)) toast('ä¸‹æ›¸ããŒã‚ã‚Šã¾ã™ï¼šã€Œä¸‹æ›¸ãå¾©å…ƒã€ã§æˆ»ã›ã¾ã™');
  }

  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init, {once:true}); } else { init(); }
})();
</script>
</body>
</html>
